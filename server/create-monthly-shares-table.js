// Script to create monthly_shares table and test functionality
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://uswswsiarylffxqdwiot.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzd3N3c2lhcnlsZmZ4cWR3aW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDAyNTkzNjIsImV4cCI6MjA1NTgzNTM2Mn0.zocHcEHF5SBpAqknlPp-dsnbcfmn2lGfmNTyHRWhWuw';

const supabase = createClient(supabaseUrl, supabaseKey);

async function testMonthlySharesTable() {
  console.log('Testing monthly_shares table...');
  
  // Try to insert a test monthly share
  const testShare = {
    person_id: 1,
    month_key: '2025-05',
    percentage_share: 25.5
  };
  
  const { data, error } = await supabase
    .from('monthly_shares')
    .insert(testShare)
    .select();
    
  if (error) {
    console.error('Monthly shares table does not exist or has permission issues:', error);
    console.log('\nTo create the monthly_shares table, please run this SQL in your Supabase dashboard:');
    console.log('\n' + `
-- Create monthly_shares table to track percentage shares per month
CREATE TABLE IF NOT EXISTS public.monthly_shares (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    person_id BIGINT NOT NULL,
    month_key TEXT NOT NULL,
    percentage_share DECIMAL(5, 2) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    
    -- Foreign key constraint
    CONSTRAINT fk_person_monthly_share FOREIGN KEY (person_id) REFERENCES public.people(id) ON DELETE CASCADE,
    
    -- Unique constraint to ensure one percentage per person per month
    CONSTRAINT unique_person_month_share UNIQUE (person_id, month_key),
    
    -- Check constraint to ensure percentage is between 0 and 100
    CONSTRAINT check_percentage_range CHECK (percentage_share >= 0 AND percentage_share <= 100)
);

-- Grant permissions
GRANT ALL ON public.monthly_shares TO anon;
GRANT ALL ON public.monthly_shares_id_seq TO anon;

-- Create indexes for faster queries
CREATE INDEX IF NOT EXISTS idx_monthly_shares_month_key ON public.monthly_shares(month_key);
CREATE INDEX IF NOT EXISTS idx_monthly_shares_person_id ON public.monthly_shares(person_id);
    `.trim());
  } else {
    console.log('Monthly shares table exists and working! Test data inserted:', data);
    
    // Clean up test data
    await supabase
      .from('monthly_shares')
      .delete()
      .eq('person_id', 1)
      .eq('month_key', '2025-05');
    console.log('Test data cleaned up.');
  }
}

testMonthlySharesTable();